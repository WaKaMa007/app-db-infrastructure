name: Application Deployment

on:
  workflow_run:
    workflows: ["Terraform Deploy"]
    types:
      - completed
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        type: choice
        options:
          - dev
          - staging
          - prod
      version:
        description: 'Application version/tag'
        required: false
        default: 'latest'
      wait_for_refresh:
        description: 'Wait for instance refresh to complete'
        required: false
        type: boolean
        default: false

env:
  AWS_REGION: us-east-1
  TERRAFORM_DIR: infrastructure-web-app/terraform

jobs:
  deploy-app:
    name: Deploy Application
    runs-on: ubuntu-latest
    # Determine environment: use input if provided, otherwise default to 'prod' for master branch
    # Note: For workflow_run triggers, we'll determine the actual environment in the steps
    # ####################################
    environment:
      name: ${{ github.event.inputs.environment || 'prod' }}
      url: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Get workspace
        id: workspace
        uses: ./.github/actions/get-workspace
        with:
          environment: ${{ github.event.inputs.environment }}

      - name: Setup Terraform
        uses: ./.github/actions/terraform-setup
        with:
          terraform_dir: ${{ env.TERRAFORM_DIR }}
          state_bucket: ${{ secrets.TF_STATE_BUCKET }}
          state_key: ${{ secrets.TF_STATE_KEY }}
          state_region: ${{ secrets.TF_STATE_REGION }}
          workspace: ${{ steps.workspace.outputs.workspace }}

      - name: Get S3 bucket name
        id: s3-bucket
        uses: ./.github/actions/get-terraform-output
        with:
          terraform_dir: ${{ env.TERRAFORM_DIR }}
          output_name: s3_bucket_app_assets

      - name: Prepare Application Code
        id: prepare-app
        run: |
          # Create a deployment package
          mkdir -p /tmp/app-deploy
          
          # If application directory exists, use it
          if [ -d "application" ]; then
            cp -r application/* /tmp/app-deploy/
          else
            # Otherwise, extract from userdata script (fallback)
            echo "âš ï¸  No application directory found, using userdata script"
            cp infrastructure-web-app/terraform/scripts/userdata_client_app.sh /tmp/app-deploy/
          fi
          
          # Create version file
          echo "${{ github.event.inputs.version || github.sha }}" > /tmp/app-deploy/VERSION
          echo "${{ github.run_id }}" > /tmp/app-deploy/DEPLOY_ID
          echo "$(date -u +%Y-%m-%dT%H:%M:%SZ)" > /tmp/app-deploy/DEPLOY_TIME
          
          # Calculate checksum
          cd /tmp/app-deploy
          find . -type f -exec sha256sum {} \; | sha256sum | cut -d' ' -f1 > CHECKSUM
          
          echo "deploy_path=/tmp/app-deploy" >> $GITHUB_OUTPUT

      - name: Upload to S3
        run: |
          echo "Uploading application to S3 bucket: ${{ steps.s3-bucket.outputs.value }}"
          aws s3 sync ${{ steps.prepare-app.outputs.deploy_path }} \
            s3://${{ steps.s3-bucket.outputs.value }}/scripts/ \
            --region ${{ env.AWS_REGION }} \
            --delete

      - name: Get ASG name
        id: asg-name
        uses: ./.github/actions/get-terraform-output
        with:
          terraform_dir: ${{ env.TERRAFORM_DIR }}
          output_name: asg_name

      - name: Trigger Instance Refresh
        id: instance-refresh
        run: |
          ASG_NAME="${{ steps.asg-name.outputs.value }}"
          REGION="${{ env.AWS_REGION }}"
          
          echo "Starting instance refresh for ASG: $ASG_NAME"
          
          # Check if refresh is already in progress
          ACTIVE_REFRESH=$(aws autoscaling describe-instance-refreshes \
            --auto-scaling-group-name "$ASG_NAME" \
            --region "$REGION" \
            --query 'InstanceRefreshes[?Status==`InProgress` || Status==`Pending`].InstanceRefreshId' \
            --output text 2>/dev/null || echo "")
          
          if [ -n "$ACTIVE_REFRESH" ] && [ "$ACTIVE_REFRESH" != "None" ]; then
            echo "âš ï¸  Instance refresh already in progress: $ACTIVE_REFRESH"
            echo "refresh_id=$ACTIVE_REFRESH" >> $GITHUB_OUTPUT
            echo "status=existing" >> $GITHUB_OUTPUT
          else
            # Start new instance refresh
            # Note: AutoRollback=false because we don't provide DesiredConfiguration
            # The instance refresh will update instances to match the current launch template
            REFRESH_ID=$(aws autoscaling start-instance-refresh \
              --auto-scaling-group-name "$ASG_NAME" \
              --region "$REGION" \
              --preferences "MinHealthyPercentage=50,InstanceWarmup=120,AutoRollback=false" \
              --query 'InstanceRefreshId' \
              --output text)
            
            echo "âœ… Instance refresh started: $REFRESH_ID"
            echo "refresh_id=$REFRESH_ID" >> $GITHUB_OUTPUT
            echo "status=new" >> $GITHUB_OUTPUT
          fi

      - name: Instance Refresh Info (Non-blocking)
        if: github.event.inputs.wait_for_refresh != 'true' || github.event_name == 'workflow_run'
        run: |
          ASG_NAME="${{ steps.asg-name.outputs.value }}"
          REFRESH_ID="${{ steps.instance-refresh.outputs.refresh_id }}"
          REGION="${{ env.AWS_REGION }}"
          
          echo "âœ… Instance refresh started: $REFRESH_ID"
          echo "â­ï¸  Refresh will continue in background - workflow continues without waiting"
          echo ""
          echo "ðŸ“Š Monitor refresh status:"
          echo ""
          echo "Via AWS CLI:"
          echo "  aws autoscaling describe-instance-refreshes \\"
          echo "    --auto-scaling-group-name $ASG_NAME \\"
          echo "    --instance-refresh-ids $REFRESH_ID \\"
          echo "    --region $REGION"
          echo ""
          echo "Via AWS Console:"
          echo "  https://console.aws.amazon.com/ec2autoscaling/home?region=${REGION}#/details/${ASG_NAME}?view=history"
          echo ""
          echo "The instance refresh will complete in the background (typically 10-30 minutes)."

      - name: Wait for Instance Refresh (Blocking)
        if: github.event.inputs.wait_for_refresh == 'true' && github.event_name == 'workflow_dispatch'
        run: |
          ASG_NAME="${{ steps.asg-name.outputs.value }}"
          REFRESH_ID="${{ steps.instance-refresh.outputs.refresh_id }}"
          REGION="${{ env.AWS_REGION }}"
          MAX_WAIT=3600  # 60 minutes (increased for large deployments)
          INTERVAL=30
          ELAPSED=0
          
          echo "Monitoring instance refresh: $REFRESH_ID"
          
          while [ $ELAPSED -lt $MAX_WAIT ]; do
            STATUS=$(aws autoscaling describe-instance-refreshes \
              --auto-scaling-group-name "$ASG_NAME" \
              --instance-refresh-ids "$REFRESH_ID" \
              --region "$REGION" \
              --query 'InstanceRefreshes[0].Status' \
              --output text)
            
            echo "Refresh status: $STATUS (elapsed: ${ELAPSED}s)"
            
            if [ "$STATUS" == "Successful" ]; then
              echo "âœ… Instance refresh completed successfully"
              exit 0
            elif [ "$STATUS" == "Failed" ] || [ "$STATUS" == "Cancelled" ]; then
              echo "âŒ Instance refresh $STATUS"
              exit 1
            fi
            
            sleep $INTERVAL
            ELAPSED=$((ELAPSED + INTERVAL))
          done
          
          # Check final status before failing
          FINAL_STATUS=$(aws autoscaling describe-instance-refreshes \
            --auto-scaling-group-name "$ASG_NAME" \
            --instance-refresh-ids "$REFRESH_ID" \
            --region "$REGION" \
            --query 'InstanceRefreshes[0].Status' \
            --output text 2>/dev/null || echo "Unknown")
          
          if [ "$FINAL_STATUS" == "Successful" ]; then
            echo ""
            echo "âœ… Instance refresh completed successfully (checked after timeout)"
            exit 0
          else
            echo ""
            echo "âš ï¸  Instance refresh timeout after ${MAX_WAIT}s ($((MAX_WAIT / 60)) minutes)"
            echo "   Current status: $FINAL_STATUS"
            echo "   The refresh may still be running in AWS."
            echo ""
            echo "   Check status:"
            echo "   aws autoscaling describe-instance-refreshes --auto-scaling-group-name $ASG_NAME --instance-refresh-ids $REFRESH_ID --region $REGION"
            echo ""
            echo "   Or check AWS Console:"
            echo "   https://console.aws.amazon.com/ec2autoscaling/home?region=${REGION}#/details/${ASG_NAME}?view=history"
            echo ""
            echo "   The workflow will continue - you can check the refresh status manually."
            # Don't exit with error - allow workflow to continue
            exit 0
          fi

      - name: Get ALB URL
        id: alb-url
        uses: ./.github/actions/get-terraform-output
        with:
          terraform_dir: ${{ env.TERRAFORM_DIR }}
          output_name: alb_https_url

      - name: Health Check
        id: health-check
        run: |
          ALB_URL="${{ steps.alb-url.outputs.value }}"
          
          echo "Performing health check on: $ALB_URL"
          
          MAX_RETRIES=10
          RETRY_DELAY=30
          
          for i in $(seq 1 $MAX_RETRIES); do
            if curl -f -s "$ALB_URL/health" > /dev/null; then
              echo "âœ… Health check passed"
              exit 0
            fi
            echo "Health check attempt $i/$MAX_RETRIES failed, retrying in ${RETRY_DELAY}s..."
            sleep $RETRY_DELAY
          done
          
          echo "âŒ Health check failed after $MAX_RETRIES attempts"
          exit 1

      - name: Deployment Summary
        if: always()
        run: |
          echo "## Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Environment:** ${{ steps.workspace.outputs.workspace }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Version:** ${{ github.event.inputs.version || github.sha }}" >> $GITHUB_STEP_SUMMARY
                echo "- **S3 Bucket:** ${{ steps.s3-bucket.outputs.value }}" >> $GITHUB_STEP_SUMMARY
                echo "- **ASG:** ${{ steps.asg-name.outputs.value }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Instance Refresh:** ${{ steps.instance-refresh.outputs.refresh_id }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Status:** ${{ job.status }}" >> $GITHUB_STEP_SUMMARY

