name: Blue/Green Deployment

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        type: choice
        options:
          - staging
          - prod
      version:
        description: 'Application version/tag'
        required: false
        default: 'latest'

env:
  AWS_REGION: us-east-1
  TERRAFORM_DIR: infrastructure-web-app/terraform

jobs:
  blue-green-deploy:
    name: Blue/Green Deployment
    runs-on: ubuntu-latest
    environment:
      name: ${{ github.event.inputs.environment }}
      url: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Get workspace
        id: workspace
        uses: ./.github/actions/get-workspace
        with:
          environment: ${{ github.event.inputs.environment }}

      - name: Setup Terraform
        uses: ./.github/actions/terraform-setup
        with:
          terraform_dir: ${{ env.TERRAFORM_DIR }}
          state_bucket: ${{ secrets.TF_STATE_BUCKET }}
          state_key: ${{ secrets.TF_STATE_KEY }}
          state_region: ${{ secrets.TF_STATE_REGION }}
          workspace: ${{ steps.workspace.outputs.workspace }}

      - name: Get target group ARN
        id: target-group
        uses: ./.github/actions/get-terraform-output
        with:
          terraform_dir: ${{ env.TERRAFORM_DIR }}
          output_name: target_group_arn

      - name: Get ASG name (Blue)
        id: asg-name
        uses: ./.github/actions/get-terraform-output
        with:
          terraform_dir: ${{ env.TERRAFORM_DIR }}
          output_name: asg_name

      - name: Get ALB ARN
        id: alb-arn
        uses: ./.github/actions/get-terraform-output
        with:
          terraform_dir: ${{ env.TERRAFORM_DIR }}
          output_name: alb_arn

      - name: Get S3 bucket name
        id: s3-bucket
        uses: ./.github/actions/get-terraform-output
        with:
          terraform_dir: ${{ env.TERRAFORM_DIR }}
          output_name: s3_bucket_app_assets

      - name: Identify Blue Environment (Current Production)
        id: blue-info
        run: |
          # NOTE: This is NOT a true blue/green deployment.
          # Current infrastructure doesn't support separate blue/green environments.
          # This workflow performs a safer rolling deployment with testing.
          #
          # For true blue/green, you would need:
          # 1. Separate ASG for green environment (created via Terraform)
          # 2. Separate target group for green (created via Terraform)
          # 3. ALB listener rules with weighted routing
          # 4. Traffic shifting logic (0% → 10% → 50% → 100%)
          # 5. Rollback path (switch back to blue if green fails)
          #
          # Until infrastructure supports this, we use rolling deployment.
          
          echo "target_group_arn=${{ steps.target-group.outputs.value }}" >> $GITHUB_OUTPUT
          echo "asg_name=${{ steps.asg-name.outputs.value }}" >> $GITHUB_OUTPUT
          
          # In true blue/green, green would use different ASG/TG
          # For now, same ASG (rolling update)
          echo "green_asg_name=${{ steps.asg-name.outputs.value }}" >> $GITHUB_OUTPUT
          echo "green_tg_arn=${{ steps.target-group.outputs.value }}" >> $GITHUB_OUTPUT

      - name: Prepare Green Application Code
        run: |
          mkdir -p /tmp/green-deploy
          
          if [ -d "application" ]; then
            cp -r application/* /tmp/green-deploy/
          else
            cp infrastructure-web-app/terraform/scripts/userdata_client_app.sh /tmp/green-deploy/
          fi
          
          echo "${{ github.event.inputs.version || github.sha }}" > /tmp/green-deploy/VERSION
          echo "${{ github.run_id }}" > /tmp/green-deploy/DEPLOY_ID
          echo "$(date -u +%Y-%m-%dT%H:%M:%SZ)" > /tmp/green-deploy/DEPLOY_TIME

      - name: Upload Green Code to S3
        run: |
          aws s3 sync /tmp/green-deploy \
            s3://${{ steps.s3-bucket.outputs.value }}/scripts/ \
            --region ${{ env.AWS_REGION }} \
            --delete

      - name: Deploy to Green Environment
        run: |
          # NOTE: This is a rolling deployment, not true blue/green
          # In true blue/green: Create new ASG with green launch template
          ASG_NAME="${{ steps.blue-info.outputs.green_asg_name }}"
          
          echo "Starting deployment to green environment..."
          
          # Check for active refresh
          ACTIVE_REFRESH=$(aws autoscaling describe-instance-refreshes \
            --auto-scaling-group-name "$ASG_NAME" \
            --region ${{ env.AWS_REGION }} \
            --query 'InstanceRefreshes[?Status==`InProgress` || Status==`Pending`].InstanceRefreshId' \
            --output text 2>/dev/null || echo "")
          
          if [ -z "$ACTIVE_REFRESH" ] || [ "$ACTIVE_REFRESH" == "None" ]; then
            # Start instance refresh for green
            REFRESH_ID=$(aws autoscaling start-instance-refresh \
              --auto-scaling-group-name "$ASG_NAME" \
              --region ${{ env.AWS_REGION }} \
              --preferences "MinHealthyPercentage=100,InstanceWarmup=120,AutoRollback=true" \
              --query 'InstanceRefreshId' \
              --output text)
            
            echo "refresh_id=$REFRESH_ID" >> $GITHUB_OUTPUT
            
            # Wait for green to be healthy
            echo "Waiting for green environment to be healthy..."
            MAX_WAIT=1800
            INTERVAL=30
            ELAPSED=0
            
            while [ $ELAPSED -lt $MAX_WAIT ]; do
              STATUS=$(aws autoscaling describe-instance-refreshes \
                --auto-scaling-group-name "$ASG_NAME" \
                --instance-refreshes "$REFRESH_ID" \
                --region ${{ env.AWS_REGION }} \
                --query 'InstanceRefreshes[0].Status' \
                --output text)
              
              if [ "$STATUS" == "Successful" ]; then
                echo "✅ Green environment ready"
                break
              elif [ "$STATUS" == "Failed" ]; then
                echo "❌ Green deployment failed"
                exit 1
              fi
              
              sleep $INTERVAL
              ELAPSED=$((ELAPSED + INTERVAL))
            done
          fi

      - name: Get ALB URL
        id: alb-url
        uses: ./.github/actions/get-terraform-output
        with:
          terraform_dir: ${{ env.TERRAFORM_DIR }}
          output_name: alb_https_url

      - name: Integration Tests on Green
        id: green-tests
        run: |
          ALB_URL="${{ steps.alb-url.outputs.value }}"
          
          if [ -z "$ALB_URL" ]; then
            echo "⚠️  Could not get ALB URL, skipping integration tests"
            echo "test_result=skipped" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          echo "Running integration tests on green environment: $ALB_URL"
          
          # Run integration tests
          if [ -f "application/tests/test_integration.py" ]; then
            pip install pytest requests
            export TEST_URL="$ALB_URL"
            if pytest application/tests/test_integration.py -v; then
              echo "✅ Integration tests passed"
              echo "test_result=passed" >> $GITHUB_OUTPUT
            else
              echo "❌ Integration tests failed"
              echo "test_result=failed" >> $GITHUB_OUTPUT
              exit 1
            fi
          else
            echo "No integration tests found, skipping"
            echo "test_result=skipped" >> $GITHUB_OUTPUT
          fi

      - name: Switch Traffic to Green
        if: steps.green-tests.outputs.test_result != 'failed'
        run: |
          # In full blue/green: Update ALB listener rule to route 100% traffic to green
          # For current setup: Traffic is already on the updated instances
          
          echo "✅ Green environment is healthy and tested"
          echo "Traffic switch complete (using rolling deployment)"
          
          # Full implementation would:
          # 1. Update ALB listener rule weights (100% green, 0% blue)
          # 2. Monitor green for issues
          # 3. Optionally terminate blue after verification period

      - name: Monitor Green Environment
        run: |
          echo "Monitoring green environment for 5 minutes..."
          ALB_URL="${{ steps.alb-url.outputs.value }}"
          
          if [ -z "$ALB_URL" ]; then
            echo "⚠️  Could not get ALB URL, skipping monitoring"
            exit 0
          fi
          
          MONITOR_DURATION=300  # 5 minutes
          INTERVAL=30
          ELAPSED=0
          ERROR_COUNT=0
          
          while [ $ELAPSED -lt $MONITOR_DURATION ]; do
            if ! curl -f -s "$ALB_URL/health" > /dev/null; then
              ERROR_COUNT=$((ERROR_COUNT + 1))
              echo "⚠️  Health check failed (errors: $ERROR_COUNT)"
            fi
            
            if [ $ERROR_COUNT -gt 5 ]; then
              echo "❌ Too many health check failures, consider rollback"
              exit 1
            fi
            
            sleep $INTERVAL
            ELAPSED=$((ELAPSED + INTERVAL))
            echo "Monitoring... (${ELAPSED}s elapsed)"
          done
          
          echo "✅ Green environment monitoring complete"

      - name: Blue/Green Deployment Summary
        if: always()
        run: |
          echo "## Blue/Green Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Environment:** ${{ steps.workspace.outputs.workspace }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Version:** ${{ github.event.inputs.version || github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- **ASG:** ${{ steps.blue-info.outputs.asg_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Note:** This is a rolling deployment, not true blue/green" >> $GITHUB_STEP_SUMMARY
          echo "- **Integration Tests:** ${{ steps.green-tests.outputs.test_result }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Status:** ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**⚠️  WARNING:** This workflow performs a rolling deployment, NOT true blue/green." >> $GITHUB_STEP_SUMMARY
          echo "For true blue/green deployment, infrastructure changes are required:" >> $GITHUB_STEP_SUMMARY
          echo "- Separate ASG for green environment" >> $GITHUB_STEP_SUMMARY
          echo "- Separate target group for green" >> $GITHUB_STEP_SUMMARY
          echo "- ALB listener rules with weighted routing" >> $GITHUB_STEP_SUMMARY
          echo "- Traffic shifting logic (gradual 0% → 100%)" >> $GITHUB_STEP_SUMMARY
          echo "- Rollback path (switch back to blue if green fails)" >> $GITHUB_STEP_SUMMARY

